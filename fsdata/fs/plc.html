<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link rel="shortcut icon" href="img/favicon.png">
    <title>HTTP Server</title>
</head>

<body>
    <table class="table" cellspacing="10">
        <tr>
            <td>readPLCregister</td>
            <td><input type="text" name="1" id="1"></td>
            <td><input type="button" name="1-b" id="1-b" value="Send" onclick="sendCommand(this.id)"></td>
        </tr>
        <tr>
            <td>readPLCregisters</td>
            <td><input type="text" name="2" id="2"></td>
            <td><input type="button" name="2-b" id="2-b" value="Send" onclick="sendCommand(this.id)"></td>
        </tr>
        <tr>
            <td>writePLCregister</td>
            <td><input type="text" name="3" id="3"></td>
            <td><input type="button" name="3-b" id="3-b" value="Send" onclick="sendCommand(this.id)"></td>
        </tr>
        <tr>
            <td>writePLCregisters</td>
            <td><input type="text" name="4" id="4"></td>
            <td><input type="button" name="4-b" id="4-b" value="Send" onclick="sendCommand(this.id)"></td>
        </tr>
        <tr>
            <td>setPLCtxAddrType</td>
            <td><input type="text" name="5" id="5"></td>
            <td><input type="button" name="5-b" id="5-b" value="Send" onclick="sendCommand(this.id)"></td>
        </tr>
        <tr>
            <td>setPLCtxDA</td>
            <td><input type="text" name="6" id="6"></td>
            <td><input type="button" name="6-b" id="6-b" value="Send" onclick="sendCommand(this.id)"></td>
        </tr>
        <tr>
            <td>setPLCnodeLA</td>
            <td><input type="text" name="7" id="7"></td>
            <td><input type="button" name="7-b" id="7-b" value="Send" onclick="sendCommand(this.id)"></td>
        </tr>
        <tr>
            <td>setPLCnodeGA</td>
            <td><input type="text" name="8" id="8"></td>
            <td><input type="button" name="8-b" id="8-b" value="Send" onclick="sendCommand(this.id)"></td>
        </tr>
        <tr>
            <td>getPLCrxAddrType</td>
            <td><input type="text" name="9" id="9"></td>
            <td><input type="button" name="9-b" id="9-b" value="Send" onclick="sendCommand(this.id)"></td>
        </tr>
        <tr>
            <td>getPLCrxSA</td>
            <td><input type="text" name="10" id="10"></td>
            <td><input type="button" name="10-b" id="10-b" value="Send" onclick="sendCommand(this.id)"></td>
        </tr>
        <tr>
            <td>readPLCrxPacket</td>
            <td><input type="text" name="11" id="11"></td>
            <td><input type="button" name="11-b" id="11-b" value="Send" onclick="sendCommand(this.id)"></td>
        </tr>
        <tr>
            <td>readPLCintRegister</td>
            <td><input type="text" name="12" id="12"></td>
            <td><input type="button" name="12-b" id="12-b" value="Send" onclick="sendCommand(this.id)"></td>
        </tr>
        <tr>
            <td>initPLCdevice</td>
            <td><input type="text" name="13" id="13"></td>
            <td><input type="button" name="13-b" id="13-b" value="Send" onclick="sendCommand(this.id)"></td>
        </tr>
    </table>
    <div class="sub" align="center" id="status_box"></div>
    <script type="text/javascript"></script>
    <script>
        var ws;
        var retries;

        window.onload = function() {
            wsOpen();
        }

        function setMsg(text) {
            sbox = document.getElementById('status_box');
            sbox.innerHTML = text;
            console.log(text);
        }

        function onMessage(evt) {
            retries = 0;
            setMsg(evt.data);
        }

        function wsOpen() {
            if (ws === undefined || ws.readyState != 0) {
                if (retries)
                    setMsg("Problems occured while connecting to device, retrying...");
                var uri = "/plc-function";
                ws = new WebSocket("ws://" + location.host + uri);
                ws.binaryType = 'arraybuffer';
                ws.onopen = function(evt) {
                    retries = 0;
                    setMsg("Ready to set configuration.");
                };
                ws.onerror = function(evt) {
                    setMsg("Error connecting to device...");
                };
                ws.onmessage = function(evt) {
                    onMessage(evt);
                };
                retries = 0;
            }
        }

        function wsWrite(data) {
            if (ws.readyState == 3 || retries++ > 5)
                wsOpen();
            if (ws.readyState == 1)
                ws.send(data);
        }

        function sendCommand(id) {
            var command = new Object();
            var comm_id = id.substr(0, id.indexOf('-'));
            var comm_input = document.getElementById(comm_id)
            command.data = comm_input.parentElement.previousElementSibling.innerHTML;
            command.value = comm_input.value.split(',');
            var jsonString = JSON.stringify(command);
            wsWrite(jsonString);
            console.log(jsonString);
        }
    </script>
</body>